<Window x:Class="OrderingSpecialEquipment.Views.Reports.ReportPreviewWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2006"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:views="clr-namespace:OrderingSpecialEquipment.Views.Reports"
        xmlns:converters="clr-namespace:OrderingSpecialEquipment.Converters"
        xmlns:models="clr-namespace:OrderingSpecialEquipment.Models.Reports"
        mc:Ignorable="d"
        Title="Предпросмотр отчета" Height="800" Width="1400"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <converters:CurrencyConverter x:Key="CurrencyConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBooleanConverter x:Key="InverseBoolToVis"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Заголовок и панель управления -->
        <Border Style="{StaticResource CardStyle}" 
                Margin="0,0,0,16"
                Padding="24">
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="&#xE773;" 
                             FontFamily="Segoe MDL2 Assets"
                             FontSize="28"
                             Foreground="{StaticResource AccentColor}"
                             Margin="0,0,16,0"/>
                    <TextBlock Text="{Binding ReportTitle}" 
                             Style="{StaticResource SectionHeaderStyle}"
                             Margin="0,0,0,4"/>
                </StackPanel>
                <TextBlock Text="Настройте параметры отчета и нажмите 'Сформировать отчет'" 
                         FontSize="14"
                         Foreground="{StaticResource SecondaryTextColor}"/>
            </StackPanel>
        </Border>

        <!-- Основное содержимое -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Панель параметров -->
            <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                <views:ReportParametersControl DataContext="{Binding Parameters}"/>
            </Border>

            <!-- Разделитель -->
            <GridSplitter Grid.Column="1" 
                          Width="8" 
                          HorizontalAlignment="Stretch"
                          Background="Transparent"
                          Cursor="SizeWE"/>

            <!-- Результаты отчета -->
            <Border Grid.Column="2" Style="{StaticResource CardStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Панель управления отчетом -->
                    <Border Grid.Row="0" 
                            Background="{StaticResource HoverBackground}"
                            CornerRadius="6"
                            Padding="16"
                            Margin="0,0,0,16">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="Сформировать отчет" 
                                    Command="{Binding GenerateReportCommand}"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Padding="20,10"
                                    Margin="0,0,12,0">
                                <Button.ContentTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE896;" 
                                                     FontSize="14" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </Button.ContentTemplate>
                            </Button>

                            <Button Content="Экспорт в Excel" 
                                    Command="{Binding ExportToExcelCommand}"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Padding="20,10"
                                    Margin="0,0,12,0"
                                    Visibility="{Binding IsReportGenerated, Converter={StaticResource BoolToVis}}">
                                <Button.ContentTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE73C;" 
                                                     FontSize="14" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </Button.ContentTemplate>
                            </Button>

                            <Button Content="Печать" 
                                    Command="{Binding PrintReportCommand}"
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Padding="20,10"
                                    Visibility="{Binding IsReportGenerated, Converter={StaticResource BoolToVis}}">
                                <Button.ContentTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE749;" 
                                                     FontSize="14" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </Button.ContentTemplate>
                            </Button>
                        </StackPanel>
                    </Border>

                    <!-- Индикатор загрузки -->
                    <Border Grid.Row="1" 
                            Background="#CCFFFFFF" 
                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                            Panel.ZIndex="100">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <ProgressBar IsIndeterminate="True" Width="200" Height="6" 
                                         Foreground="{StaticResource AccentColor}" />
                            <TextBlock Text="{Binding StatusMessage}" 
                                       Margin="0,16,0,0"
                                       FontSize="14"
                                       Foreground="{StaticResource TextColor}" />
                        </StackPanel>
                    </Border>

                    <!-- Таблица результатов -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding ReportItems}"
                              Visibility="{Binding IsReportGenerated, Converter={StaticResource BoolToVis}}"
                              Style="{StaticResource ModernDataGridStyle}"
                              RowStyle="{StaticResource ModernDataGridRowStyle}"
                              CellStyle="{StaticResource ModernDataGridCellStyle}"
                              ColumnHeaderStyle="{StaticResource ModernDataGridColumnHeaderStyle}"
                              AutoGenerateColumns="False"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling">
                        <DataGrid.Columns>
                            <!-- Динамические колонки будут добавлены в коде при загрузке окна -->
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Сообщение при отсутствии данных -->
                    <Border Grid.Row="1" 
                            Visibility="{Binding IsReportGenerated, Converter={StaticResource InverseBoolToVis}}"
                            Background="{StaticResource HoverBackground}"
                            CornerRadius="8"
                            Padding="32">
                        <StackPanel HorizontalAlignment="Center">
                            <TextBlock Text="&#xE946;" 
                                     FontFamily="Segoe MDL2 Assets"
                                     FontSize="48"
                                     Foreground="{StaticResource SecondaryTextColor}"
                                     HorizontalAlignment="Center"/>
                            <TextBlock Text="Отчет еще не сформирован" 
                                     FontSize="18"
                                     FontWeight="SemiBold"
                                     Foreground="{StaticResource TextColor}"
                                     Margin="0,16,0,8"
                                     HorizontalAlignment="Center"/>
                            <TextBlock Text="Настройте параметры слева и нажмите кнопку 'Сформировать отчет'" 
                                     FontSize="14"
                                     Foreground="{StaticResource SecondaryTextColor}"
                                     TextAlignment="Center"
                                     MaxWidth="400"/>
                        </StackPanel>
                    </Border>

                    <!-- Сводная информация -->
                    <Border Grid.Row="2" 
                            Background="{StaticResource HoverBackground}"
                            CornerRadius="6"
                            Padding="16"
                            Margin="0,16,0,0"
                            Visibility="{Binding IsReportGenerated, Converter={StaticResource BoolToVis}}">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <StackPanel Margin="0,0,24,0">
                                <TextBlock Text="Всего записей:" 
                                         Foreground="{StaticResource SecondaryTextColor}"/>
                                <TextBlock Text="{Binding ReportSummary.TotalRecords}" 
                                         FontSize="16"
                                         FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,24,0">
                                <TextBlock Text="Общая сумма:" 
                                         Foreground="{StaticResource SecondaryTextColor}"/>
                                <TextBlock Text="{Binding ReportSummary.TotalAmount, Converter={StaticResource CurrencyConverter}}" 
                                         FontSize="16"
                                         FontWeight="SemiBold"
                                         Foreground="{StaticResource AccentColor}"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,24,0">
                                <TextBlock Text="Всего часов:" 
                                         Foreground="{StaticResource SecondaryTextColor}"/>
                                <TextBlock Text="{Binding ReportSummary.TotalHours, StringFormat={}{0:N2}}" 
                                         FontSize="16"
                                         FontWeight="SemiBold"/>
                            </StackPanel>

                            <StackPanel>
                                <TextBlock Text="% выполнения:" 
                                         Foreground="{StaticResource SecondaryTextColor}"/>
                                <TextBlock Text="{Binding ReportSummary.CompletionPercentage, StringFormat={}{0:F2}%}" 
                                         FontSize="16"
                                         FontWeight="SemiBold"
                                         Foreground="{Binding ReportSummary.CompletionPercentage, Converter={StaticResource CompletionToColor}}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!-- Кнопка закрытия -->
        <Button Grid.Row="2" 
                Content="Закрыть" 
                Command="{Binding CloseCommand}"
                HorizontalAlignment="Right"
                Style="{StaticResource PrimaryButtonStyle}"
                Background="{StaticResource SecondaryBackground}"
                Foreground="{StaticResource TextColor}"
                BorderBrush="{StaticResource BorderColor}"
                BorderThickness="1.5"
                Padding="24,10"/>
    </Grid>
</Window>